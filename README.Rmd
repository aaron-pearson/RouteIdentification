---
output: github_document
editor_options: 
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```
# RouteIdentification

<!-- badges: start -->
<!-- badges: end -->

The goal of RouteIdentification is to clustery trajectory data sets like those found in sports analytics tracking data. This work was developed as part of the first Big Data Bowl and the methodology is written about in [JQAS](https://www.degruyter.com/view/j/jqas.ahead-of-print/jqas-2019-0047/jqas-2019-0047.xml?format=INT)

## Installation

<!--You can install the released version of RouteIdentification from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("RouteIdentification")
```
 -->
 
You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("danichusfu/RouteIdentification")
```
## Example

This is a basic example which shows you how to solve a common problem:

```{r}
# devtools::install_github(repo = "danichusfu/RouteIdentification")

library(RouteIdentification)
library(readr)

cluster_controls <- generate_random_cluster_controls(number_of_clusters = 3)

nested_trajectory_data <-
  generate_sample_data(cluster_controls, number_of_curves = 20) %>%
  select(curve_i, x, y, cluster = cluster_num)


em_results <-
  nested_trajectory_data %>%
  unnest(cols = c(x, y)) %>%
  cluster_trajectory_data(K = 3)


cluster_means <-
  extract_cluster_means(em_results)

nested_trajectory_data %>%
  bind_cols(as_tibble(em_results$Pik)) %>%
  mutate(curve_i = row_number()) %>%
  pivot_longer(names_to = "pred_cluster", values_to = "prob", matches("\\d")) %>%
  mutate(pred_cluster = parse_number(pred_cluster)) %>%
  group_by(curve_i) %>%
  filter(prob == max(prob)) %>%
  ungroup() %>%
  count(cluster, pred_cluster)

nested_trajectory_data %>%
  bind_cols(as_tibble(em_results$Pik)) %>%
  mutate(curve_i = row_number()) %>%
  pivot_longer(names_to = "pred_cluster", values_to = "prob", matches("\\d")) %>%
  mutate(pred_cluster = parse_number(pred_cluster)) %>%
  group_by(curve_i) %>%
  filter(prob == max(prob)) %>%
  unnest(cols = c(x, y)) %>%
ggplot(aes(x = x, y = y, group = curve_i, colour = factor(cluster))) +
  geom_path() +
  facet_wrap(~ pred_cluster)


ggplot(cluster_means, aes(x = V1, y = V2, colour = factor(cluster))) +
  geom_path()+
  facet_wrap(~ cluster)

new_nested_trajectory_data <-
  generate_sample_data(cluster_controls) %>%
  select(curve_i, x, y, cluster = cluster_num)


new_trajectory_data <- new_nested_trajectory_data %>% unnest(cols = c(x, y))

new_data_fit <- fit_new_data(new_trajectory_data, em_results)

new_data_fit %>%
  count(cluster, cluster_assigned)
```

```{r}
# replace this with actual nfl route that has been transformed properly. Its incoming
fit_new_data(new_trajectory_data, nfl_em_results) %>%
  left_join(cluster_route_map, by = c("cluster_assigned" = "cluster"))
```

## Now with NFL sample data


```{r}
# Use online sample data from big data bowl

# list all the files
#tracking_files <- list.files(path = "Data/", pattern = "tracking_.*\\.csv")

# Load all the data
routes_data <- 
  # create the tibble with the file names
  tibble(file_name = "https://raw.githubusercontent.com/nfl-football-ops/Big-Data-Bowl/master/Data/tracking_gameId_2017090700.csv") %>%
  # read the data in nested
  mutate(data = map(file_name, read_routes_from_csv)) %>%
  dplyr::select(-file_name) %>% 
  unnest(cols = c(data))

# transform our curves
routes_data <-
  routes_data %>%
  mutate(row = row_number()) %>%
  mutate(data = pmap(list(data, team, direction_left, line_of_scrimmage), 
                     ~ cut_plays(..1) %>%
                       flip_field(., ..2, ..3, ..4)),
         n = map_dbl(data, nrow)) %>%
  filter(n >= 2) %>%
  # left side of field is TRUE
  mutate(data_same_sideline = purrr::map(data, 
                                         ~ mutate(., 
                                                  sof = 160/6 > first(y),
                                                  y = if_else(sof, 160/3 - y, y),
                                                  y = y - first(y)
                                         ) %>%
                                           dplyr::select(-sof)))  %>%
  arrange(row)


routes_data <-
  routes_data %>%
  ungroup() %>%
  select(-row)


routes_data %>%
  mutate(curve_num = row_number()) %>%
  unnest(cols = c(data_same_sideline)) %>%
  select(curve_num, x, y) %>%
  fit_new_data(nfl_em_results) %>%
  left_join(cluster_route_map, by = c("cluster_assigned" = "cluster"))
```


## Now with the higlight data from 903124


```{r}
# Use online sample data from big data bowl

# list all the files
#tracking_files <- list.files(path = "Data/", pattern = "tracking_.*\\.csv")

# Load all the data
routes_data <- 
  # create the tibble with the file names
  tibble(file_name = "https://raw.githubusercontent.com/danichusfu/NFL_Highlight_Tracking/master/Highligh_19_post.csv") %>%
  # read the data in nested
  mutate(data = map(file_name, read_routes_from_903124)) %>%
  dplyr::select(-file_name) %>% 
  unnest(cols = c(data))

# transform our curves
routes_data <-
  routes_data %>%
  mutate(row = row_number()) %>%
  mutate(data = pmap(list(data, left, line_of_scrimmage), 
                     ~ cut_plays(..1) %>%
                       flip_field_903124(., ..2, ..3)),
         n = map_dbl(data, nrow)) %>%
  filter(n >= 2) %>%
  # left side of field is TRUE
  mutate(data_same_sideline = purrr::map(data, 
                                         ~ mutate(., 
                                                  sof = 160/6 > first(y),
                                                  y = if_else(sof, 160/3 - y, y),
                                                  y = y - first(y)
                                         ) %>%
                                           dplyr::select(-sof)))  %>%
  arrange(row)


routes_data <-
  routes_data %>%
  ungroup() %>%
  select(-row)


fitted_clusters <-
  routes_data %>%
  mutate(curve_num = row_number()) %>%
  unnest(cols = c(data_same_sideline)) %>%
  select(curve_num, x, y) %>%
  fit_new_data(nfl_em_results) %>%
  left_join(cluster_route_map, by = c("cluster_assigned" = "cluster"))

fitted_clusters

routes_data %>%
  select(displayName, gameId, playId) %>%
  bind_cols(fitted_clusters %>% select(route_name))


```
